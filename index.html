<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ECMO Support v61</title>
  <style>
    :root { --accent: #f1c40f; --bg-dark: #2c3e50; --header-bg: #1a5276; --alert: #e74c3c; }
    body { margin: 0; padding: 0; background-color: #f0f2f5; font-family: sans-serif; display: flex; justify-content: center; }
    #app { width: 100%; max-width: 480px; background: #fff; min-height: 100vh; display: flex; flex-direction: column; }
    .header { background: var(--header-bg); color: white; padding: 12px 15px; text-align: center; font-weight: bold; }
    
    .dashboard-main { background: var(--bg-dark); color: white; padding: 15px 10px 5px 10px; text-align: center; }
    .val-large { font-size: 3.5rem; font-weight: bold; color: var(--accent); line-height: 1; }
    
    .dashboard-sub { background: var(--bg-dark); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
    .status-box { background: rgba(255,255,255,0.1); border-radius: 6px; padding: 8px 5px; text-align: center; }
    .label-mini { font-size: 0.7rem; color: #bdc3c7; margin-bottom: 2px; }
    .val-med { font-size: 1.2rem; font-weight: bold; color: white; }
    
    .alert-active { background: var(--alert) !important; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.7; } }

    .content { padding: 15px; }
    .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    label { font-size: 0.75rem; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: #fff; }
    
    /* 血管内径表示エリア（カニューレの下へ） */
    .vessel-info { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin-top: -5px; margin-bottom: 15px; }
    .vessel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .vessel-val { font-weight: bold; color: #2c3e50; font-size: 0.9rem; margin-top: 2px; }

    .chart-container { height: 160px; margin: 10px 0; }
    .report-box { background: #2d3436; color: #dfe6e9; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 0.8rem; border-left: 4px solid var(--accent); line-height: 1.4; }
  </style>
</head>
<body>

<div id="app">
  <div class="header">ECMO Support v61</div>

  <div class="dashboard-main">
    <div class="label-mini">予測実流量 (L/min)</div>
    <div id="v_flow" class="val-large">0.00</div>
  </div>

  <div class="dashboard-sub">
    <div class="status-box">
      <div class="label-mini">予測 P1 / P2 (mmHg)</div>
      <div class="val-med"><span id="v_p1" style="color:#ff7675;">-</span> / <span id="v_p2" style="color:#74b9ff;">-</span></div>
    </div>
    <div id="ratio_box" class="status-box">
      <div class="label-mini">DO2 / VO2 比</div>
      <div id="v_ratio" class="val-med">-</div>
    </div>
    <div class="status-box">
      <div class="label-mini">BSA (m²)</div>
      <div id="v_bsa" class="val-med">-</div>
    </div>
    <div class="status-box">
      <div class="label-mini">目標流量 (CI 2.4)</div>
      <div id="v_target" class="val-med">-</div>
    </div>
  </div>

  <div class="content">
    <div class="grid-row">
      <div><label>身長 (cm)</label><input type="number" id="h" value="170" oninput="calc()"></div>
      <div><label>体重 (kg)</label><input type="number" id="w" value="65" oninput="calc()"></div>
    </div>

    <div class="grid-row">
      <div><label>Hb (g/dL)</label><input type="number" id="hb" value="10.0" step="0.1" oninput="calc()"></div>
      <div><label>回転数 (RPM)</label><input type="number" id="rpm" value="2500" step="100" oninput="calc()"></div>
    </div>
    
    <div class="grid-row">
      <div><label>脱血カニューレ</label>
        <select id="v_dFr" onchange="calc()">
          <option value="p_v24">PCKC 24Fr (Mera)</option>
          <option value="t_v21" selected>テルモ 21Fr</option>
          <option value="t_v195">テルモ 19.5Fr</option>
        </select>
      </div>
      <div><label>送血カニューレ</label>
        <select id="v_rFr" onchange="calc()">
          <option value="p_a20">PCKC 20Fr (Mera)</option>
          <option value="t_r165">テルモ 16.5Fr</option>
          <option value="t_r15" selected>テルモ 15Fr</option>
        </select>
      </div>
    </div>

    <div class="vessel-info">
      <div class="vessel-grid">
        <div>
          <div class="label-mini" style="color:#7f8c8d">脱血 推奨/限界 血管径</div>
          <div id="v_d_vessel" class="vessel-val">- / - mm</div>
        </div>
        <div>
          <div class="label-mini" style="color:#7f8c8d">送血 推奨/限界 血管径</div>
          <div id="v_r_vessel" class="vessel-val">- / - mm</div>
        </div>
      </div>
    </div>

    <div class="chart-container"><canvas id="v_chart"></canvas></div>
    <div id="v_sum" class="report-box"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    let chart = null;
    const db = {
        d: { "p_v24": {r:3.5, fr:24}, "t_v21": {r:8.6, fr:21}, "t_v195": {r:12.5, fr:19.5} },
        r: { "p_a20": {r:2.5, fr:20}, "t_r165": {r:15.5, fr:16.5}, "t_r15": {r:24.5, fr:15} },
        ox: 4.5, tube: 1.2
    };

    window.calc = () => {
        const hb = parseFloat(document.getElementById('hb').value) || 10;
        const rpm = parseInt(document.getElementById('rpm').value) || 0;
        const h = parseFloat(document.getElementById('h').value) || 170, w = parseFloat(document.getElementById('w').value) || 65;
        const d_key = document.getElementById('v_dFr').value, r_key = document.getElementById('v_rFr').value;
        
        const bsa = Math.sqrt(h * w / 3600);
        const vF = 0.5 + Math.pow((hb*3)/35, 2) * 0.5;
        const d_data = db.d[d_key], r_data = db.r[r_key];
        const sysR = (d_data.r + r_data.r + db.ox + db.tube);

        const getVessel = (fr) => {
            const od = fr / 3;
            return { rec: (od / 0.66).toFixed(1), lim: (od / 0.83).toFixed(1) };
        };
        const dV = getVessel(d_data.fr), rV = getVessel(r_data.fr);
        document.getElementById('v_d_vessel').innerText = `${dV.rec} / ${dV.lim} mm`;
        document.getElementById('v_r_vessel').innerText = `${rV.rec} / ${rV.lim} mm`;

        let rawQ = 0;
        for(let q=0; q<=8; q+=0.01) {
            let resP = sysR * Math.pow(q, 1.75) * vF;
            let pumpP = (460 * Math.pow(rpm/3000, 2)) - (20 * q * (rpm/3000));
            if(pumpP > resP) rawQ = q; else break;
        }

        const clinicalF = rawQ * 0.93;
        const estP1 = -((d_data.r + 0.8) * Math.pow(clinicalF, 1.75) * vF * 1.6).toFixed(0);
        const estP2 = ((r_data.r + db.ox + 0.4) * Math.pow(clinicalF, 1.75) * vF + 75).toFixed(0);
        const ratio = ((hb * 1.34) * clinicalF * 10) / (bsa * 125);
        
        document.getElementById('v_flow').innerText = clinicalF.toFixed(2);
        document.getElementById('v_p1').innerText = estP1;
        document.getElementById('v_p2').innerText = estP2;
        document.getElementById('v_bsa').innerText = bsa.toFixed(2);
        document.getElementById('v_target').innerText = (bsa * 2.4).toFixed(1) + " L/min";
        document.getElementById('v_ratio').innerText = ratio.toFixed(1);
        document.getElementById('ratio_box').className = ratio <= 2.0 ? 'status-box alert-active' : 'status-box';

        const ctx = document.getElementById('v_chart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 41}, (_, i) => (i * 0.2).toFixed(1)),
                datasets: [
                    { data: Array.from({length: 41}, (_, i) => sysR * Math.pow(i*0.2, 1.75) * vF), borderColor: '#333', pointRadius: 0, fill: false },
                    { data: Array.from({length: 41}, (_, i) => Math.max(0, (460 * Math.pow(rpm/3000, 2)) - (20 * (i*0.2) * (rpm/3000)))), borderColor: '#2ecc71', borderDash: [5, 5], pointRadius: 0, fill: false },
                    { data: [{x: clinicalF.toFixed(2), y: (460 * Math.pow(rpm/3000, 2)) - (20 * clinicalF * (rpm/3000))}], pointRadius: 8, backgroundColor: 'red', showLine: false }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', min: 0, max: 6 }, y: { min: 0, max: 500 } }, plugins: { legend: { display: false } } }
        });
        document.getElementById('v_sum').innerText = `【分析レポート】\n身長・体重から目標CI 2.4を算出。\nカニューレ選定に対し、占有率66%を推奨、83%を限界径としてガイドを表示。`;
    };
    calc();
})();
</script>
</body>
</html>
